function thpp=id4link(q)

global m1 m2 m3 m4 L1 L2 L3 a4 d1 dd2 I2 I3 I4 I1yy I2zz I3yy g n kT feff;  

C1=cos(q(1));
C2=cos(q(2));
C4=cos(q(4));

S1=sin(q(1));
S2=sin(q(2));
S4=sin(q(4));

S24=S2*C4+C2*S4;
C24=C2*C4-S2*S4;

% The constants from Annex B
K0=m2*(.5*L2-dd2)^2 +m3*(.5*L3)^2;
K1=.5*(I4+.25*m4*a4^2);
K2=.5*(I2-I2zz+I3-I3yy+K0);
K3=I2+I3+K0+2*K1;
K4=m3+m4;
K5=.5*(2*I1yy+I2zz+I3yy+K3);



f1q3= .5*K4*q(3)^2-.5*m3*L3*q(3);
f2q3= m4*a4*q(3);
fq4 = .5*a4*m4*C4;

d11=K5+f1q3 -(K2+f1q3)*cos(2*q(2))+K1*cos(2*(q(2)+q(4))) - f2q3*C24*S2;
d22= K3+2*f1q3+f2q3*S4;
d24= 2*K1+.5*f2q3*S4;


D=[d11 0 0 0; 0 d22 fq4 d24;  0 fq4 K4 fq4; 0  d24  fq4 2*K1];


C= [-1/4*q(5)*((4*a4*m4*q(3)*cos(2*q(2) + q(4)) - (4*I2 - 4*I2zz + 4*I3 - 4*I3yy + m2*(-2*dd2 + L2)^2  + m3*L3^2 ...
    - 4*L3*m3*q(3) + 4*(m3 + m4)*q(3)^2)*sin(2*q(2)) + (4*I4 + m4*a4^2)*sin(2*(q(2) + q(4))))*q(6) + ...
    4*S2*(a4*m4*C24 + (L3*m3 - 2*(m3 + m4)*q(3))*S2)*q(7) +2*((4*I4 + m4*a4^2)*C24 - 2*a4*m4*q(3)*S2)*S24*q(8));
            
     1/8*((4*a4*m4*q(3)*cos(2*q(2) + q(4)) - (4*I2 - 4*I2zz + 4*I3 - 4*I3yy + m2*(-2*dd2 + L2)^2  + m3*L3^2 - ...
         4*L3*m3*q(3) + 4*(m3 + m4)*q(3)^2)*sin(2*q(2)) + (4*I4 + m4*a4^2)*sin(2*(q(2) + q(4))))*q(5)^2 ...
       + 4*a4*m4*q(3)*C4*q(8)^2 + 8*q(6)*((-L3*m3+2*(m3+m4)*q(3)+a4*m4*S4)*q(7)+a4*m4*q(3)*C4*q(8))) + ...
       .5*(a4*g*m4*C24+g*(2*dd2*m2-L2*m2+L3*m3-2*(m3+m4)*q(3))*S2);
                        
     1/4*(2*S2*(a4*m4*C24 + (L3*m3 - 2*(m3 + m4)*q(3))*S2)*q(5)^2 +2*(L3*m3-2*(m3 + m4)*q(3))*q(6)^2 ...
         -2*a4*m4*S4*(q(6)+ q(8))^2) + g*(m3+m4)*C2;
            
     1/4*(((4*I4 + m4*a4^2)*C24- 2*a4*m4*q(3)*S2)*S24*q(5)^2 - 2*a4*m4*q(6)*(q(3)*C4*q(6) -2*S4*q(7)))+.5*a4*g*m4*C24
        ];

        Jm=1340e-7*[1 0 0 0;0 1 0 0;0 0 1 0; 0 0 0 1];     
      %thpp=inv(D+n^2*Jm)*(q(9:12)*0.0592*n-C-n^2*7.7e-5*q(5:8));  
          thpp=inv(D+n^2*Jm)*(q(9:12)*kT*n-C-n^2*feff*q(5:8));  
    